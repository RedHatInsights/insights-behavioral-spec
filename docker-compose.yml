version: "3"
services:
  # "pod" with the tests
  bddtests:
    image: quay.io/ccxdev/insights-behavioral-spec:ci
    entrypoint:
      - /bin/sh
      - -c
      - "sleep infinity"
  database:
    ports:
      - 5432:5432
    image: postgres:13.9
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=${POSTGRES_DB_NAME}
  kafka:
    profiles:
      - test-notification-services
    image: quay.io/ccxdev/kafka-no-zk:latest
    ports:
      - 9092:9092
    environment:
      - KAFKA_ADVERTISED_HOST_NAME=kafka
      - KAFKA_CREATE_TOPICS="platform.notifications.ingress:1:1"
  minio:
    profiles:
      - test-exporter
    image: minio/minio
    command:
      - server
      - /data
    ports:
      - 9000:9000
    environment:
      - MINIO_ACCESS_KEY=test_access_key
      - MINIO_SECRET_KEY=test_secret_access_key
  createbuckets:
    profiles:
      - test-exporter
    image: minio/mc
    depends_on:
      - minio
    entrypoint:
      - /bin/sh
      - -c
      - "sleep 5;
      /usr/bin/mc config host add myminio http://minio:9000 test_access_key test_secret_access_key;
      /usr/bin/mc mb myminio/test;"
  pushgateway:
    profiles:
      - no-mock
      - test-notification-services
    image: quay.io/prometheus/pushgateway:latest
    ports:
      - 9091:9091
    command:
      - --web.enable-admin-api
  initializenotificationdb:
    profiles:
      - test-notification-services
    image: quay.io/cloudservices/ccx-notification-writer:latest
    entrypoint:
      - /bin/sh
      - -c
      - 'export CCX_NOTIFICATION_WRITER__STORAGE__DB_DRIVER=postgres CCX_NOTIFICATION_WRITER__STORAGE__PG_PARAMS="sslmode=disable" CCX_NOTIFICATION_WRITER__STORAGE__PG_USERNAME=postgres CCX_NOTIFICATION_WRITER__STORAGE__PG_PASSWORD=postgres CCX_NOTIFICATION_WRITER__STORAGE__PG_HOST=database CCX_NOTIFICATION_WRITER__STORAGE__PG_PORT=5432 CCX_NOTIFICATION_WRITER__STORAGE__PG_DB_NAME=notification && ./ccx-notification-writer --db-init-migration && ./ccx-notification-writer --db-init && ./ccx-notification-writer --migrate latest'

  content-service:
    profiles:
      - no-mock
    image: quay.io/cloudservices/ccx-insights-content-service
    ports:
      - 8082:8082
    environment:
      - INSIGHTS_CONTENT_SERVICE__SERVER__ADDRESS=:8082
      - INSIGHTS_CONTENT_SERVICE__SERVER__API_PREFIX=/api/v1/
      - INSIGHTS_CONTENT_SERVICE__SERVER__API_SPEC_FILE=/openapi/openapi.json
      - INSIGHTS_CONTENT_SERVICE__GROUPS__PATH=/groups/groups_config.yaml
  init-service-log-db:
    profiles:
      - no-mock
    image: postgres:13.9
    volumes:
      - ./setup/:/tmp/setup-scripts
    entrypoint: sh
    environment:
      - PGPASSWORD=postgres
    command: >
      psql 
        --username=postgres --host=db --port=5432 --dbname notification
        -f /tmp/setup-scripts/ocm_service_log.sql

  service-log:
    depends_on:
      - init-service-log-db
    profiles:
      - no-mock
    image: quay.io/ccxdev/ocm-service-log
    ports:
      - 8000:8000 # API server
      - 8083:8083 # Healthcheck
      - 8080:8080 # Metrics
    command: >
      sh -c "echo db > secrets/db.host
        ./ocm-service-log serve \
        --api-server-bindaddress "localhost:8000" \
        --health-check-server-bindaddress "localhost:8083" \
        --metrics-server-bindaddress "localhost:8080" \
        --enable-ocm-mock
      "
